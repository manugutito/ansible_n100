- name: Incrementally install stuff to diagnose
  hosts: n100
  tasks:
  # One could do this differently but this works
  - name: Copy sshd config file
    become: yes
    ansible.builtin.copy:
      src: ./config_files/sshd_config
      dest: /etc/ssh/sshd_config
      remote_src: no
      backup: yes
      owner: root
      group: root
      mode: '0640'
  - name: Restart sshd to apply config
    become: yes
    service:
      name: ssh
      state: restarted
  - name: Update and upgrade apt packages
    become: true
    apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400
  - name: Install a few things
    become: true
    apt:
      update_cache: yes
      cache_valid_time: 86400
      name:
        - iotop
        - minidlna
        - openseachest
        - powertop
        - samba
  # Bear in mind that no effort was made to find the right path for the Realtek NIC
  - name: Edit file to enable ASPM on the Realtek NIC
    become: true
    ansible.builtin.lineinfile:
      path: /sys/bus/pci/drivers/r8169/0000:02:00.0/link/l1_aspm
      regexp: '0'
      line: '1'
  # This may not be a great idea to run blindly. Also it is not idempotent
  - name: Run powertop --auto-tune
    become: true
    ansible.builtin.shell: powertop --auto-tune
  - name: Install ZFS
    become: true
    apt:
      update_cache: yes
      cache_valid_time: 86400
      name:
        - zfsutils-linux
      state: latest
  - name: Copy minidlna config
    become: yes
    ansible.builtin.copy:
      src: ./config_files/minidlna.conf
      dest: /etc/minidlna.conf
      remote_src: no
      backup: yes
      owner: root
      group: root
      mode: '0644'
  - name: Create hdd group
    become: yes
    ansible.builtin.group:
      name: hdd
      state: present
  - name: add minidlna to group hdd
    become: yes
    ansible.builtin.user:
      name: minidlna
      groups: hdd
      append: yes
  - name: add mjgutierrez to group hdd
    become: yes
    ansible.builtin.user:
      name: mjgutierrez
      groups: hdd
      append: yes
  - name: Restart minidlna to apply config
    become: yes
    service:
      name: minidlna
      state: restarted
